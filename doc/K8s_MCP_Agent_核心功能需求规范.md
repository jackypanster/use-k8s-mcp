# K8s MCP Agent 核心功能需求规范

## 📋 系统定义

### 唯一目标
**本系统的唯一目标是通过自然语言接口管理Kubernetes集群**

- 提供直观的自然语言交互界面
- 实现对真实K8s集群的智能化运维管理
- 确保所有操作基于真实集群数据，绝不编造信息

## 🔄 核心工作流程

```
用户自然语言输入 
    ↓
Gemini 2.5 Flash智能决策
    ↓
调用相应的K8s MCP工具
    ↓
返回真实集群数据
    ↓
提供分析建议
```

### 详细流程说明

1. **用户输入阶段**
   - 接收自然语言形式的K8s运维需求
   - 支持中英文混合输入
   - 理解复杂的运维场景描述

2. **智能决策阶段**
   - Gemini 2.5 Flash分析用户意图
   - 确定需要调用的MCP工具
   - 构造正确的工具调用参数

3. **工具调用阶段**
   - 调用K8s MCP服务器的相应工具
   - 获取真实集群数据
   - 处理工具调用结果

4. **数据分析阶段**
   - 基于真实数据提供运维分析
   - 识别潜在问题和优化建议
   - 格式化输出用户友好的结果

## 🏗️ 技术架构

```
用户 ↔ MCP Agent ↔ Gemini 2.5 Flash ↔ K8s MCP服务器 ↔ 真实K8s集群
```

### 组件职责

#### 1. 用户界面层
- **职责**: 接收用户输入，展示结果
- **技术**: 命令行界面 (CLI)
- **要求**: 简洁直观，支持交互式操作

#### 2. MCP Agent层
- **职责**: 协调各组件，管理工作流程
- **技术**: Python + LangChain + MCP-Use
- **要求**: 高可靠性，完整的错误处理

#### 3. Gemini 2.5 Flash层
- **职责**: 自然语言理解，智能决策，结果分析
- **技术**: Google Gemini 2.5 Flash via OpenRouter
- **要求**: 严格遵循数据真实性原则

#### 4. K8s MCP服务器层
- **职责**: 提供K8s集群操作工具
- **技术**: Go + MCP协议
- **要求**: 稳定可靠，工具定义完整

#### 5. K8s集群层
- **职责**: 提供真实的集群数据和操作接口
- **技术**: Kubernetes API
- **要求**: 生产级可用性

## 🚫 数据真实性铁律

### 绝对禁止行为

1. **❌ 编造数据**
   - Gemini 2.5 Flash绝对禁止编造任何K8s集群数据
   - 不得基于AI训练知识假设集群状态
   - 不得提供未经验证的配置建议

2. **❌ 模拟响应**
   - 禁止返回示例性质的集群信息
   - 禁止使用占位符数据
   - 禁止基于常见配置进行推测

3. **❌ 知识填补**
   - 当MCP工具调用失败时，不得用AI知识填补空白
   - 不得基于历史经验推断当前状态
   - 不得提供无法验证的故障排查建议

### 严格遵循原则

1. **✅ 数据溯源**
   - 所有集群信息必须来自K8s MCP工具的真实返回
   - 每个数据点都必须能追溯到具体的工具调用
   - 保持完整的调用链路记录

2. **✅ 实时验证**
   - 所有操作基于当前集群的实时状态
   - 定期刷新缓存数据
   - 确保信息的时效性

3. **✅ 透明度**
   - 明确标识数据来源
   - 显示工具调用的详细过程
   - 提供可验证的操作路径

### AI职责边界

#### Gemini 2.5 Flash的职责范围

1. **✅ 理解用户意图**
   - 解析自然语言输入
   - 识别运维需求类型
   - 确定操作优先级

2. **✅ 选择合适的MCP工具**
   - 根据需求选择正确的工具
   - 构造准确的调用参数
   - 处理工具调用序列

3. **✅ 基于真实数据提供运维分析建议**
   - 分析真实集群数据
   - 识别异常模式
   - 提供优化建议

#### Gemini 2.5 Flash的禁止行为

1. **❌ 不得编造集群数据**
2. **❌ 不得假设集群配置**
3. **❌ 不得提供未验证的信息**

### 数据验证机制

1. **工具调用验证**
   ```python
   # 每个工具调用都必须验证
   if not tool_result.success:
       raise MCPToolCallError(f"工具调用失败: {tool_result.error}")
   ```

2. **数据完整性检查**
   ```python
   # 验证返回数据的完整性
   if not validate_cluster_data(cluster_info):
       raise DataIntegrityError("集群数据不完整或无效")
   ```

3. **溯源记录**
   ```python
   # 记录数据来源
   result.metadata = {
       "source_tool": tool_name,
       "call_timestamp": timestamp,
       "cluster": cluster_name
   }
   ```

### 失败处理原则

1. **如实报告**
   - MCP工具调用失败时，必须如实报告
   - 提供具体的错误信息
   - 不得用AI知识掩盖失败

2. **优雅降级**
   - 部分工具失败时，明确标识可用和不可用的功能
   - 提供替代的查询方法
   - 建议用户检查集群连接

3. **错误分类**
   - 网络连接错误
   - 权限不足错误
   - 集群资源不存在错误
   - MCP服务器错误

## 🎯 核心功能清单

### 1. 集群管理
- 获取集群信息
- 列出可用集群
- 检查集群健康状态

### 2. 资源操作
- 查看Pod、Service、Deployment等资源
- 获取资源详细信息
- 监控资源状态变化

### 3. 故障排查
- 分析Pod日志
- 检查节点状态
- 网络连接诊断

### 4. 性能监控
- 资源使用情况
- 性能指标分析
- 容量规划建议

### 5. 运维分析
- 基于真实数据的趋势分析
- 异常检测和告警
- 优化建议

## 📊 质量保证

### 测试要求
1. **功能测试**: 验证所有MCP工具调用正常
2. **数据真实性测试**: 确保无模拟数据
3. **错误处理测试**: 验证失败场景的正确处理
4. **性能测试**: 确保响应时间合理

### 监控指标
1. **工具调用成功率**: > 95%
2. **数据准确性**: 100%
3. **响应时间**: < 30秒
4. **用户满意度**: 基于真实数据的有用性

## 🔒 安全要求

1. **访问控制**: 确保只有授权用户可以访问集群
2. **操作审计**: 记录所有集群操作
3. **数据保护**: 保护敏感的集群信息
4. **权限最小化**: 只请求必要的集群权限

## 📈 成功标准

1. **用户能够通过自然语言高效管理K8s集群**
2. **所有输出数据都基于真实集群状态**
3. **系统具有高可靠性和可用性**
4. **提供有价值的运维洞察和建议**

---

**版本**: 1.0  
**创建日期**: 2025-06-18  
**最后更新**: 2025-06-18  
**状态**: 已确认并实施
