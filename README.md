# K8s MCP Agent - Kubernetesé›†ç¾¤ç®¡ç†ç³»ç»Ÿ

åŸºäºGemini 2.5 Flashå’ŒMCP (Model Context Protocol) çš„æ™ºèƒ½Kubernetesé›†ç¾¤ç®¡ç†ç³»ç»Ÿã€‚

## ğŸš€ æ ¸å¿ƒåŠŸèƒ½

### 1. æ™ºèƒ½é›†ç¾¤äº¤äº’ (ä¸»åº”ç”¨)
- **æ–‡ä»¶**: `src/main.py`
- **åŠŸèƒ½**: åŸºäºLLM Agentçš„æ™ºèƒ½K8sé›†ç¾¤ç®¡ç†
- **ç‰¹ç‚¹**: è‡ªç„¶è¯­è¨€äº¤äº’ï¼Œå®æ—¶é›†ç¾¤æ“ä½œ

### 2. é›†ç¾¤æ‰«æç³»ç»Ÿ (æ‰«æåº”ç”¨)
- **æ–‡ä»¶**: `src/k8s_scanner.py`
- **åŠŸèƒ½**: è‡ªåŠ¨å‘ç°MCPå·¥å…·å¹¶æ‰«æé›†ç¾¤èµ„æº
- **ç‰¹ç‚¹**: å®šæœŸæ‰«æï¼Œæ•°æ®ç¼“å­˜ï¼Œèµ„æºç›‘æ§

## ğŸ“‹ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·äº¤äº’      â”‚    â”‚   é›†ç¾¤æ‰«æ      â”‚    â”‚   å…±äº«å±‚        â”‚
â”‚   (main.py)     â”‚    â”‚ (k8s_scanner.py)â”‚    â”‚                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ LLM Agent     â”‚    â”‚ â€¢ å·¥å…·å‘ç°      â”‚    â”‚ â€¢ MCPå·¥å…·       â”‚
â”‚ â€¢ è‡ªç„¶è¯­è¨€äº¤äº’  â”‚    â”‚ â€¢ èµ„æºæ‰«æ      â”‚    â”‚ â€¢ SQLiteç¼“å­˜    â”‚
â”‚ â€¢ å®æ—¶æ“ä½œ      â”‚    â”‚ â€¢ æ•°æ®ç¼“å­˜      â”‚    â”‚ â€¢ é…ç½®ç®¡ç†      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ K8s MCP Server  â”‚
                    â”‚ (çœŸå®K8sé›†ç¾¤)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ› ï¸ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒé…ç½®

åˆ›å»º `.env` æ–‡ä»¶ï¼š

```bash
# LLMé…ç½® (Gemini 2.5 Flash)
OPENROUTER_API_KEY=your_openrouter_api_key
OPENROUTER_BASE_URL=https://openrouter.ai/api/v1
LLM_MODEL_NAME=google/gemini-2.5-flash
LLM_MAX_INPUT_CONTEXT=1048576
LLM_MAX_OUTPUT_TOKENS=32768
LLM_TEMPERATURE=0.0

# MCPæœåŠ¡å™¨é…ç½®
MCP_SERVER_URL=http://your-k8s-mcp-server:port/sse
MCP_SERVER_TYPE=sse
MCP_SERVER_NAME=k8s
```

### 2. å®‰è£…ä¾èµ–

```bash
uv sync
```

### 3. ä½¿ç”¨æ–¹æ³•

#### æ™ºèƒ½é›†ç¾¤äº¤äº’
```bash
# å¯åŠ¨æ™ºèƒ½Agent
uv run python src/main.py
```

#### é›†ç¾¤æ‰«æç³»ç»Ÿ
```bash
# å‘ç°MCPå·¥å…·
uv run python src/k8s_scanner.py discover

# æ‰«ææŒ‡å®šé›†ç¾¤
uv run python src/k8s_scanner.py scan --cluster production-cluster

# å®Œæ•´æ‰«ææµç¨‹ (å·¥å…·å‘ç° + é›†ç¾¤æ‰«æ)
uv run python src/k8s_scanner.py full-scan --cluster production-cluster

# åˆ—å‡ºç¼“å­˜çš„èµ„æº
uv run python src/k8s_scanner.py list
```

## ğŸ“Š æ•°æ®ç®¡ç†

### ç¼“å­˜æ•°æ®åº“
- **ä½ç½®**: `data/k8s_cache.db`
- **ç±»å‹**: SQLite
- **å†…å®¹**: é›†ç¾¤ä¿¡æ¯ã€å‘½åç©ºé—´ã€èŠ‚ç‚¹ã€Podã€æœåŠ¡ã€MCPå·¥å…·

## ğŸ”§ å·¥å…·å’Œè„šæœ¬

### ä¿ç•™çš„å®ç”¨å·¥å…·
- `script/check-scan-env.py` - ç¯å¢ƒé…ç½®æ£€æŸ¥
- `script/list-available-tools.py` - åˆ—å‡ºå¯ç”¨MCPå·¥å…·
- `script/query-cache-db.py` - æŸ¥è¯¢ç¼“å­˜æ•°æ®åº“
- `script/verify-scan-status.py` - éªŒè¯æ‰«æçŠ¶æ€

### æ–‡æ¡£
- `script/cluster-scanning-user-guide.md` - æ‰«æç³»ç»Ÿç”¨æˆ·æŒ‡å—
- `script/cluster-state-caching-system.md` - ç¼“å­˜ç³»ç»ŸæŠ€æœ¯æ–‡æ¡£
- `script/system-architecture-working-principles.md` - ç³»ç»Ÿæ¶æ„åŸç†

## ğŸ—ï¸ ç³»ç»Ÿç»„ä»¶

### æ ¸å¿ƒæ¨¡å—
```
src/
â”œâ”€â”€ main.py                 # æ™ºèƒ½Agentä¸»åº”ç”¨
â”œâ”€â”€ k8s_scanner.py         # é›†ç¾¤æ‰«æå™¨ä¸»åº”ç”¨
â”œâ”€â”€ llm_config.py          # LLMé…ç½®ç®¡ç†
â”œâ”€â”€ cache/                 # ç¼“å­˜ç³»ç»Ÿ
â”‚   â”œâ”€â”€ cache_manager.py   # ç¼“å­˜ç®¡ç†å™¨
â”‚   â”œâ”€â”€ models.py          # æ•°æ®æ¨¡å‹
â”‚   â””â”€â”€ database.py        # æ•°æ®åº“æ“ä½œ
â”œâ”€â”€ scanner/               # æ‰«æç³»ç»Ÿ
â”‚   â”œâ”€â”€ tool_discovery.py  # å·¥å…·å‘ç°
â”‚   â”œâ”€â”€ cluster_scan_app.py # é›†ç¾¤æ‰«æåº”ç”¨
â”‚   â”œâ”€â”€ cluster_scanner.py  # é›†ç¾¤æ‰«æå™¨
â”‚   â”œâ”€â”€ resource_parser.py  # èµ„æºè§£æå™¨
â”‚   â””â”€â”€ scan_coordinator.py # æ‰«æåè°ƒå™¨
â””â”€â”€ mcp_tools/             # MCPå·¥å…·ç®¡ç†
    â”œâ”€â”€ tool_loader.py     # å·¥å…·åŠ è½½å™¨
    â””â”€â”€ models.py          # å·¥å…·æ¨¡å‹
```

## ğŸ”„ å·¥ä½œæµç¨‹

### 1. å·¥å…·å‘ç°æµç¨‹
1. é€šè¿‡LLM Agentè°ƒç”¨MCPæœåŠ¡å™¨
2. è·å–æ‰€æœ‰å¯ç”¨çš„K8s MCPå·¥å…·
3. è§£æå·¥å…·ä¿¡æ¯ï¼ˆåç§°ã€æè¿°ã€å‚æ•°ç­‰ï¼‰
4. ç¼“å­˜å·¥å…·ä¿¡æ¯åˆ°SQLiteæ•°æ®åº“

### 2. é›†ç¾¤æ‰«ææµç¨‹
1. åŠ è½½ç¼“å­˜çš„MCPå·¥å…·ä¿¡æ¯
2. ä½¿ç”¨Agentè°ƒç”¨ç›¸åº”å·¥å…·æ‰«æé›†ç¾¤èµ„æº
3. è§£ææ‰«æç»“æœ
4. ç¼“å­˜èµ„æºä¿¡æ¯åˆ°SQLiteæ•°æ®åº“
5. åº”ç”¨TTLç­–ç•¥ç®¡ç†æ•°æ®ç”Ÿå‘½å‘¨æœŸ

### 3. æ™ºèƒ½äº¤äº’æµç¨‹
1. ç”¨æˆ·è¾“å…¥è‡ªç„¶è¯­è¨€è¯·æ±‚
2. LLM Agentåˆ†æç”¨æˆ·æ„å›¾
3. é€‰æ‹©åˆé€‚çš„MCPå·¥å…·æˆ–æŸ¥è¯¢ç¼“å­˜
4. æ‰§è¡Œæ“ä½œå¹¶è¿”å›ç»“æœ

## ğŸ“ˆ ç›‘æ§å’Œç»´æŠ¤

### æ‰«æçŠ¶æ€ç›‘æ§
```bash
# æ£€æŸ¥æ‰«æçŠ¶æ€
uv run python script/verify-scan-status.py

# æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡
uv run python script/query-cache-db.py
```

### ç¯å¢ƒæ£€æŸ¥
```bash
# éªŒè¯ç¯å¢ƒé…ç½®
uv run python script/check-scan-env.py
```

## ğŸš« å·²æ¸…ç†çš„Demoç¨‹åº

ä¸ºäº†ä¿æŒä»£ç åº“çš„æ•´æ´ï¼Œå·²åˆ é™¤ä»¥ä¸‹demoç¨‹åºï¼š
- `script/fixed-scan-demo-v2.py`
- `script/fixed-scan-demo.py`
- `script/complete-scan-with-cache.py`
- `script/debug-agent-response.py`
- `script/run-scan-demo.sh`
- `script/run-scanner-demo.py`
- `script/simple-cache-test.py`
- `script/simple-scan-test.py`

## ğŸ“ é…ç½®è¯´æ˜

ç³»ç»Ÿéµå¾ªåäºŒè¦ç´ åº”ç”¨æ–¹æ³•è®ºï¼Œæ‰€æœ‰é…ç½®é€šè¿‡ç¯å¢ƒå˜é‡ç®¡ç†ï¼š

- **LLMé…ç½®**: OpenRouter APIå¯†é’¥ã€æ¨¡å‹å‚æ•°
- **MCPé…ç½®**: æœåŠ¡å™¨åœ°å€ã€è¿æ¥ç±»å‹
- **ç¼“å­˜é…ç½®**: æ•°æ®åº“è·¯å¾„ã€TTLè®¾ç½®
- **æ‰«æé…ç½®**: æ‰«æé—´éš”ã€è¶…æ—¶è®¾ç½®

## ğŸ”’ å®‰å…¨æ³¨æ„äº‹é¡¹

- ç”Ÿäº§éƒ¨ç½²å‰è¯·ç§»é™¤ä»£ç ä¸­çš„ç§æœ‰åŸŸåä¿¡æ¯
- ç¡®ä¿APIå¯†é’¥å®‰å…¨å­˜å‚¨
- å®šæœŸæ›´æ–°ä¾èµ–åŒ…
- ç›‘æ§MCPæœåŠ¡å™¨è¿æ¥çŠ¶æ€

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
1. ç³»ç»Ÿæ¶æ„æ–‡æ¡£: `script/system-architecture-working-principles.md`
2. ç”¨æˆ·æŒ‡å—: `script/cluster-scanning-user-guide.md`
3. æŠ€æœ¯æ–‡æ¡£: `script/cluster-state-caching-system.md`